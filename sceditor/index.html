<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCEditor - Screenshot Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            /* Light gray bg */
            overflow: hidden;
            /* Prevent scrolling on main body */
        }

        /* Custom Scrollbar for sidebar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 20px;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #7c3aed;
            /* Purple-600 */
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd6fe;
            /* Purple-200 */
            border-radius: 2px;
        }

        input[type=range]:focus {
            outline: none;
        }

        /* Checkerboard pattern for transparent backgrounds */
        .checkerboard {
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%),
                linear-gradient(-45deg, #e5e7eb 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #e5e7eb 75%),
                linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* The Preview Canvas Wrapper */
        #capture-area {
            transition: background 0.3s ease;
            transform-style: preserve-3d;
        }

        /* The Image Container within the canvas */
        #image-wrapper {
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out, box-shadow 0.2s ease;
            will-change: transform;
        }

        /* Frames */
        .frame-light {
            padding: 12px;
            background: white;
            border-radius: inherit;
        }

        .frame-dark {
            padding: 12px;
            background: #1f2937;
            border-radius: inherit;
        }

        .frame-glass {
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: inherit;
        }

        .frame-none {
            padding: 0;
        }

        .tab-btn.active {
            background-color: white;
            color: #1f2937;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            color: #6b7280;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col text-gray-800">

    <!-- HEADER -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center px-6 shrink-0 z-20">
        <div class="flex items-center gap-2 text-purple-600">
            <i class="ph-fill ph-camera text-3xl"></i>
            <h1 class="text-xl font-bold text-gray-900">SCEditor</h1>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex overflow-hidden">

        <!-- LEFT: PREVIEW AREA -->
        <div class="flex-1 bg-gray-50 relative flex items-center justify-center p-8 overflow-auto"
            id="canvas-container">

            <!-- Clear Button -->
            <button id="clear-btn"
                class="hidden absolute top-6 right-6 bg-white/80 hover:bg-white text-gray-600 px-3 py-1.5 rounded-full text-sm font-medium shadow-sm backdrop-blur-sm transition-all z-10 items-center gap-1">
                <i class="ph ph-trash"></i> Clear
            </button>

            <!-- The Actual Canvas (White area in UI logic, but colored in practice) -->
            <!-- We set a min size to ensure it looks good -->
            <div id="capture-area"
                class="relative flex items-center justify-center w-full max-w-5xl aspect-video shadow-sm rounded-lg overflow-hidden bg-gradient-to-br from-purple-100 to-pink-100 transition-all duration-300">

                <!-- Empty State / Drop Zone -->
                <div id="drop-zone"
                    class="absolute inset-0 flex flex-col items-center justify-center bg-white/50 border-2 border-dashed border-purple-300 rounded-lg m-4 transition-all hover:bg-white/60">
                    <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-md">
                        <div
                            class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                            <i class="ph ph-upload-simple text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Add Your Image</h3>
                        <p class="text-gray-500 text-sm mb-6">Drag and drop your image here, or click to select<br>Press
                            Ctrl+V to paste from clipboard</p>
                        <button onclick="document.getElementById('file-input').click()"
                            class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                            Select Image
                        </button>
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                    </div>
                </div>

                <!-- Image Wrapper (Hidden initially) -->
                <div id="image-wrapper" class="hidden relative origin-center">
                    <!-- The actual image content -->
                    <div id="frame-container" class="frame-none transition-all duration-200">
                        <img id="preview-img" src="" alt="Preview"
                            class="block w-full h-auto object-cover rounded-lg shadow-2xl select-none draggable-none">
                    </div>
                </div>

                <!-- Watermark Container -->
                <div id="watermark-container"
                    class="absolute inset-0 pointer-events-none z-10 p-8 flex flex-col justify-end items-end transition-all duration-200">
                    <span id="watermark-label"
                        class="text-white/60 text-sm font-semibold px-3 py-1.5 bg-black/20 backdrop-blur-md rounded-lg opacity-0 transition-opacity duration-200 shadow-sm border border-white/10 flex items-center justify-center leading-normal whitespace-nowrap"></span>
                </div>
            </div>
        </div>

        <!-- RIGHT: SIDEBAR -->
        <aside class="w-80 bg-white border-l border-gray-200 flex flex-col shrink-0 z-10">

            <!-- Tabs -->
            <div class="flex p-2 gap-1 border-b border-gray-100 bg-gray-50/50">
                <button onclick="switchTab('edit')" id="tab-edit"
                    class="tab-btn active flex-1 py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-all">
                    <i class="ph ph-pencil-simple"></i> Edit
                </button>
                <button onclick="switchTab('bg')" id="tab-bg"
                    class="tab-btn flex-1 py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-all">
                    <i class="ph ph-paint-bucket"></i> BG
                </button>
                <button onclick="switchTab('export')" id="tab-export"
                    class="tab-btn flex-1 py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-all">
                    <i class="ph ph-download-simple"></i> Export
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto custom-scroll p-5">

                <!-- Empty State Message (if no image) -->
                <div id="no-image-msg"
                    class="h-full flex flex-col items-center justify-center text-center text-gray-400 mt-10">
                    <i class="ph ph-image text-5xl mb-3 opacity-50"></i>
                    <p class="text-sm font-medium">No image selected</p>
                    <p class="text-xs mt-1 max-w-[200px]">Please upload an image to start customizing its appearance.
                    </p>
                </div>

                <!-- CONTROLS (Hidden until image loaded) -->
                <div id="controls-content" class="hidden space-y-6">

                    <!-- EDIT TAB -->
                    <div id="panel-edit" class="space-y-6 animate-fade-in">
                        <!-- Round Borders -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <span>Round Borders</span>
                                <span id="val-radius">10</span>
                            </div>
                            <input type="range" id="input-radius" min="0" max="50" value="12" oninput="updateEdit()">
                        </div>

                        <!-- Size -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <span>Size</span>
                                <span id="val-scale">80%</span>
                            </div>
                            <input type="range" id="input-scale" min="30" max="100" value="80" oninput="updateEdit()">
                        </div>

                        <!-- Tilt (X/Y Rotate) -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <span>Tilt (3D)</span>
                                <span id="val-tilt">0°</span>
                            </div>
                            <input type="range" id="input-tilt" min="-45" max="45" value="0" oninput="updateEdit()">
                        </div>

                        <!-- Rotate (Z Rotate) -->
                        <div class="space-y-2">
                            <div
                                class="flex justify-between text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <span>Rotate</span>
                                <span id="val-rotate">0°</span>
                            </div>
                            <input type="range" id="input-rotate" min="-180" max="180" value="0" oninput="updateEdit()">
                        </div>

                        <hr class="border-gray-100">

                        <!-- Shadow -->
                        <div class="space-y-4">
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Shadow</p>

                            <div class="space-y-2">
                                <div class="flex justify-between text-xs text-gray-600">
                                    <span>Spread</span>
                                    <span id="val-shadow">40</span>
                                </div>
                                <input type="range" id="input-shadow" min="0" max="100" value="40"
                                    oninput="updateEdit()">
                            </div>

                            <div class="space-y-2">
                                <div class="flex justify-between text-xs text-gray-600">
                                    <span>Shadow Color</span>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="color" id="input-shadow-color" value="#000000"
                                        class="w-8 h-8 p-0 border-0 rounded cursor-pointer" oninput="updateEdit()">
                                    <span class="text-xs text-gray-500 font-mono" id="shadow-color-hex">#000000</span>
                                </div>
                            </div>
                        </div>

                        <hr class="border-gray-100">

                        <!-- Frames -->
                        <div class="space-y-3">
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Frames</p>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="setFrame('none')"
                                    class="frame-btn ring-2 ring-purple-500 ring-offset-1 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 flex flex-col items-center gap-1 transition-all"
                                    data-frame="none">
                                    <div
                                        class="w-6 h-6 rounded-full border border-gray-300 flex items-center justify-center text-gray-400">
                                        <i class="ph-bold ph-prohibit"></i>
                                    </div>
                                    <span class="text-[10px] text-gray-600">None</span>
                                </button>
                                <button onclick="setFrame('light')"
                                    class="frame-btn p-2 rounded-lg border border-gray-200 hover:bg-gray-50 flex flex-col items-center gap-1 transition-all"
                                    data-frame="light">
                                    <div class="w-6 h-6 bg-white border border-gray-200 shadow-sm rounded"></div>
                                    <span class="text-[10px] text-gray-600">Light</span>
                                </button>
                                <button onclick="setFrame('dark')"
                                    class="frame-btn p-2 rounded-lg border border-gray-200 hover:bg-gray-50 flex flex-col items-center gap-1 transition-all"
                                    data-frame="dark">
                                    <div class="w-6 h-6 bg-gray-800 border border-gray-700 shadow-sm rounded"></div>
                                    <span class="text-[10px] text-gray-600">Dark</span>
                                </button>
                                <button onclick="setFrame('glass')"
                                    class="frame-btn p-2 rounded-lg border border-gray-200 hover:bg-gray-50 flex flex-col items-center gap-1 transition-all"
                                    data-frame="glass">
                                    <div class="w-6 h-6 bg-gray-200 border border-dashed border-gray-400 rounded"></div>
                                    <span class="text-[10px] text-gray-600">Glass</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- BG TAB -->
                    <div id="panel-bg" class="hidden space-y-6 animate-fade-in">

                        <!-- Custom BG -->
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Custom BG</p>
                            <div class="flex gap-3">
                                <!-- Upload BG -->
                                <div class="relative w-12 h-12 border border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-purple-500 hover:text-purple-500 transition-colors"
                                    title="Upload Image">
                                    <i class="ph ph-plus"></i>
                                    <input type="file" id="bg-upload" class="absolute inset-0 opacity-0 cursor-pointer"
                                        accept="image/*" onchange="handleBgUpload(this)">
                                </div>
                                <!-- Color Picker -->
                                <div class="relative w-12 h-12 rounded-lg border border-gray-200 overflow-hidden cursor-pointer"
                                    title="Solid Color">
                                    <input type="color" id="bg-color-picker"
                                        class="absolute -top-2 -left-2 w-16 h-16 cursor-pointer p-0 border-0"
                                        oninput="setBgColor(this.value)">
                                </div>
                                <!-- Transparent -->
                                <button onclick="setBgTransparent()"
                                    class="w-12 h-12 rounded-lg border border-gray-200 flex items-center justify-center hover:bg-gray-50 text-gray-500 transition-colors"
                                    title="Transparent">
                                    <i class="ph-bold ph-prohibit text-lg"></i>
                                </button>
                                <!-- Random Gradient -->
                                <button onclick="setRandomBg()"
                                    class="w-12 h-12 rounded-lg border border-gray-200 flex items-center justify-center hover:bg-gray-50 text-purple-500 transition-colors"
                                    title="Random Gradient">
                                    <i class="ph ph-shuffle text-lg"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Gradients -->
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Gradients</p>
                            <div class="grid grid-cols-5 gap-2" id="gradient-grid">
                                <!-- JS will populate this -->
                            </div>
                        </div>

                        <!-- Glow Gradients -->
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Glow Gradients
                            </p>
                            <div class="grid grid-cols-5 gap-2" id="glow-grid">
                                <!-- JS will populate this -->
                            </div>
                        </div>

                        <!-- Solid Colors -->
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Solid Colors
                            </p>
                            <div class="grid grid-cols-5 gap-2" id="solid-grid">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                    </div>

                    <!-- EXPORT TAB -->
                    <div id="panel-export" class="hidden space-y-6 animate-fade-in">

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-gray-600">Quality</label>
                                <select id="export-quality"
                                    class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:border-purple-500">
                                    <option value="1">1x</option>
                                    <option value="2" selected>2x</option>
                                    <option value="3">3x</option>
                                    <option value="4">4x</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-gray-600">Format</label>
                                <select id="export-format"
                                    class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:border-purple-500">
                                    <option value="png">PNG</option>
                                    <option value="jpeg">JPEG</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-gray-600">Filename</label>
                            <div
                                class="flex items-center bg-gray-50 border border-gray-200 rounded-lg overflow-hidden focus-within:border-purple-500 focus-within:ring-1 focus-within:ring-purple-500">
                                <input type="text" id="export-name" value="screenshot-edit"
                                    class="w-full p-2 bg-transparent text-sm outline-none">
                                <span class="text-gray-400 text-xs px-2" id="filename-ext">.png</span>
                            </div>
                        </div>

                        <!-- Watermark Settings -->
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-gray-600">Watermark</label>
                            <div class="flex gap-2">
                                <input type="text" id="watermark-text" placeholder="None"
                                    class="flex-1 p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:border-purple-500"
                                    oninput="updateWatermark()">
                                <select id="watermark-pos"
                                    class="w-24 p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:border-purple-500"
                                    onchange="updateWatermark()">
                                    <option value="br">↘ BR</option>
                                    <option value="bl">↙ BL</option>
                                    <option value="tr">↗ TR</option>
                                    <option value="tl">↖ TL</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="exportImage()" id="export-btn"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium shadow-md shadow-purple-200 transition-all flex items-center justify-center gap-2">
                            <i class="ph-bold ph-download-simple"></i> Export Image
                        </button>
                    </div>

                </div>
            </div>
        </aside>
    </main>

    <script>
        // --- Constants & Data ---
        const gradients = [
            'linear-gradient(to bottom right, #c084fc, #6366f1)',
            'linear-gradient(to bottom right, #f472b6, #db2777)',
            'linear-gradient(to bottom right, #34d399, #059669)',
            'linear-gradient(to bottom right, #60a5fa, #2563eb)',
            'linear-gradient(to bottom right, #fbbf24, #d97706)',
            'linear-gradient(135deg, #FF9D6C 0%, #BB4E75 100%)',
            'linear-gradient(135deg, #0093E9 0%, #80D0C7 100%)',
            'linear-gradient(135deg, #85FFBD 0%, #FFFB7D 100%)',
            'linear-gradient(135deg, #FBDA61 0%, #FF5ACD 100%)',
            'linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 52%, #2BFF88 90%)'
        ];

        const glowGradients = [
            'radial-gradient(circle at center, #4f46e5 0%, #111827 100%)',
            'radial-gradient(circle at center, #db2777 0%, #111827 100%)',
            'radial-gradient(circle at center, #059669 0%, #111827 100%)',
            'radial-gradient(circle at center, #d97706 0%, #111827 100%)',
            'radial-gradient(circle at center, #ffffff 0%, #000000 100%)'
        ];

        const solidColors = [
            '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981',
            '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef',
            '#f43f5e', '#1f2937', '#4b5563', '#9ca3af', '#ffffff'
        ];

        // --- Elements ---
        const els = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            imageWrapper: document.getElementById('image-wrapper'),
            previewImg: document.getElementById('preview-img'),
            captureArea: document.getElementById('capture-area'),
            clearBtn: document.getElementById('clear-btn'),
            noImageMsg: document.getElementById('no-image-msg'),
            controlsContent: document.getElementById('controls-content'),
            frameContainer: document.getElementById('frame-container'),
            gradientGrid: document.getElementById('gradient-grid'),
            glowGrid: document.getElementById('glow-grid'),
            solidGrid: document.getElementById('solid-grid'),

            // Inputs
            radius: document.getElementById('input-radius'),
            scale: document.getElementById('input-scale'),
            tilt: document.getElementById('input-tilt'),
            rotate: document.getElementById('input-rotate'),
            shadow: document.getElementById('input-shadow'),
            shadowColor: document.getElementById('input-shadow-color'),
            shadowHex: document.getElementById('shadow-color-hex'),

            // Values (text)
            valRadius: document.getElementById('val-radius'),
            valScale: document.getElementById('val-scale'),
            valTilt: document.getElementById('val-tilt'),
            valRotate: document.getElementById('val-rotate'),
            valShadow: document.getElementById('val-shadow'),
        };

        let currentImage = null;

        // --- Initialization ---
        function init() {
            renderColorGrids();

            // Drag & Drop
            window.addEventListener('dragover', e => e.preventDefault());
            window.addEventListener('drop', e => {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) loadImage(file);
            });

            // Paste
            window.addEventListener('paste', e => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        loadImage(blob);
                    }
                }
            });

            // File Input
            els.fileInput.addEventListener('change', e => {
                if (e.target.files[0]) loadImage(e.target.files[0]);
            });

            // Clear Button
            els.clearBtn.addEventListener('click', clearImage);

            // Export format listener
            document.getElementById('export-format').addEventListener('change', (e) => {
                document.getElementById('filename-ext').textContent = '.' + e.target.value;
            });
        }

        // --- Logic ---

        function renderColorGrids() {
            // Gradients
            gradients.forEach(g => {
                const div = document.createElement('div');
                div.className = 'w-10 h-10 rounded-lg cursor-pointer hover:scale-105 transition-transform border border-black/5 shadow-sm';
                div.style.background = g;
                div.onclick = () => setBg(g);
                els.gradientGrid.appendChild(div);
            });
            // Glows
            glowGradients.forEach(g => {
                const div = document.createElement('div');
                div.className = 'w-10 h-10 rounded-lg cursor-pointer hover:scale-105 transition-transform border border-white/10 shadow-sm';
                div.style.background = g;
                div.onclick = () => setBg(g);
                els.glowGrid.appendChild(div);
            });
            // Solids
            solidColors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'w-10 h-10 rounded-lg cursor-pointer hover:scale-105 transition-transform border border-black/5 shadow-sm';
                div.style.backgroundColor = c;
                div.onclick = () => setBgColor(c);
                els.solidGrid.appendChild(div);
            });
        }

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                els.previewImg.src = currentImage;

                // UI Transition
                els.dropZone.classList.add('hidden');
                els.imageWrapper.classList.remove('hidden');
                els.controlsContent.classList.remove('hidden');
                els.noImageMsg.classList.add('hidden');
                els.clearBtn.classList.remove('hidden');

                // Reset edits slightly for new image? Optional. keeping prev settings is usually better UX.
                updateEdit();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            currentImage = null;
            els.previewImg.src = '';
            els.dropZone.classList.remove('hidden');
            els.imageWrapper.classList.add('hidden');
            els.controlsContent.classList.add('hidden');
            els.noImageMsg.classList.remove('hidden');
            els.clearBtn.classList.add('hidden');
            els.fileInput.value = ''; // Reset input
        }

        function switchTab(tab) {
            // Update Buttons
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'bg-white', 'text-gray-900', 'shadow-sm');
                b.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('text-gray-500');

            // Update Panels
            ['edit', 'bg', 'export'].forEach(t => {
                document.getElementById(`panel-${t}`).classList.add('hidden');
            });
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
        }

        // --- Editing Logic ---

        function updateEdit() {
            if (!currentImage) return;

            const radius = els.radius.value;
            const scale = els.scale.value;
            const tilt = els.tilt.value;
            const rotate = els.rotate.value;
            const shadow = els.shadow.value;
            const color = els.shadowColor.value;

            // Update Text Values
            els.valRadius.innerText = radius;
            els.valScale.innerText = scale + '%';
            els.valTilt.innerText = tilt + '°';
            els.valRotate.innerText = rotate + '°';
            els.valShadow.innerText = shadow;
            els.shadowHex.innerText = color;

            // Apply styles to Image Wrapper
            // Scale controls width relative to container
            els.imageWrapper.style.width = `${scale}%`;

            // Transform: We apply perspective to the wrapper's parent or the element itself. 
            // For tilt (X/Y rotation) to work well, we used preserve-3d in CSS.
            // A simple tilt usually implies rotating around Y axis or X axis. Let's do a subtle combination or just Y.
            // Based on screenshot, "Tilt" usually means Perspective Rotate Y or X. Let's do Rotate Y + X slight.
            // Actually, let's map Tilt to RotateY and Rotate to RotateZ.
            els.imageWrapper.style.transform = `perspective(1000px) rotateY(${tilt}deg) rotateZ(${rotate}deg)`;

            // Shadow & Border Radius apply to the IMG element (or frame container)
            // Shadow logic: spread affects blur and spread radius
            const shadowOpacity = 0.5;
            // Convert hex to rgba for opacity? Or just use hex. 
            // Large spread makes it look like a dispersed shadow
            const shadowBlur = shadow * 2;
            const shadowSpreadVal = shadow * 0.2;
            // Dynamic offset based on tilt could be cool, but static is safer for now.
            const shadowX = tilt * -0.5;
            const shadowY = 20; // Light comes from top

            // We apply shadow to the frame container or img
            els.frameContainer.style.boxShadow = `${shadowX}px ${shadowY}px ${shadowBlur}px ${shadowSpreadVal}px ${color}`;

            // Radius
            els.previewImg.style.borderRadius = `${radius}px`;
            // Also radius the frame if it has background
            if (els.frameContainer.classList.contains('frame-light') ||
                els.frameContainer.classList.contains('frame-dark') ||
                els.frameContainer.classList.contains('frame-glass')) {
                els.frameContainer.style.borderRadius = `${parseInt(radius) + 8}px`; // slightly larger for frame
            } else {
                els.frameContainer.style.borderRadius = `${radius}px`;
            }
        }

        function setFrame(type) {
            // Reset classes
            els.frameContainer.className = 'transition-all duration-200';
            els.frameContainer.classList.add(`frame-${type}`);

            // Update UI state
            document.querySelectorAll('.frame-btn').forEach(btn => {
                if (btn.dataset.frame === type) btn.classList.add('ring-2', 'ring-purple-500', 'ring-offset-1');
                else btn.classList.remove('ring-2', 'ring-purple-500', 'ring-offset-1');
            });

            updateEdit(); // Re-apply radius logic
        }

        function setBg(value) {
            els.captureArea.className = "relative flex items-center justify-center w-full max-w-5xl aspect-video shadow-sm rounded-lg overflow-hidden transition-all duration-300"; // Reset
            els.captureArea.style.background = value;
        }

        function setBgColor(color) {
            els.captureArea.className = "relative flex items-center justify-center w-full max-w-5xl aspect-video shadow-sm rounded-lg overflow-hidden transition-all duration-300"; // Reset
            els.captureArea.style.background = color;
            document.getElementById('bg-color-picker').value = color; // Sync picker
        }

        function setBgTransparent() {
            els.captureArea.style.background = 'none';
            els.captureArea.className = "relative flex items-center justify-center w-full max-w-5xl aspect-video shadow-sm rounded-lg overflow-hidden transition-all duration-300 checkerboard";
        }

        function setRandomBg() {
            const randomColor = () => '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
            const angle = Math.floor(Math.random() * 360);
            const color1 = randomColor();
            const color2 = randomColor();
            const bg = `linear-gradient(${angle}deg, ${color1}, ${color2})`;
            setBg(bg);
        }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    els.captureArea.style.background = `url(${e.target.result}) center/cover no-repeat`;
                    els.captureArea.classList.remove('checkerboard');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateWatermark() {
            const text = document.getElementById('watermark-text').value;
            const pos = document.getElementById('watermark-pos').value;
            const container = document.getElementById('watermark-container');
            const label = document.getElementById('watermark-label');

            if (!text.trim()) {
                label.classList.remove('opacity-100');
                label.classList.add('opacity-0');
                return;
            }

            label.innerText = text;
            label.classList.remove('opacity-0');
            label.classList.add('opacity-100');

            // Reset positioning classes (keep base classes)
            container.className = 'absolute inset-0 pointer-events-none z-10 p-8 flex flex-col transition-all duration-200';

            switch (pos) {
                case 'tl': container.classList.add('justify-start', 'items-start'); break;
                case 'tr': container.classList.add('justify-start', 'items-end'); break;
                case 'bl': container.classList.add('justify-end', 'items-start'); break;
                case 'br': container.classList.add('justify-end', 'items-end'); break;
            }
        }



        // --- Export ---

        async function exportImage() {
            if (!currentImage) return;

            const btn = document.getElementById('export-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="spinner"></div> Exporting...`;
            btn.disabled = true;

            // Default to 3x quality
            const quality = parseInt(document.getElementById('export-quality').value) || 3;
            const format = document.getElementById('export-format').value; // png or jpeg
            const filename = document.getElementById('export-name').value || 'screenshot';

            const captureNode = els.captureArea;
            const dropZone = els.dropZone;
            const watermarkLabel = document.getElementById('watermark-label');

            // 1. Store original states
            const originalCaptureOverflow = captureNode.style.overflow;
            const originalCapturePadding = captureNode.style.padding;
            const originalCaptureMargin = captureNode.style.margin;

            const originalDropZoneDisplay = dropZone.style.display;

            const originalWatermarkDisplay = watermarkLabel.style.display;
            const originalWatermarkLineHeight = watermarkLabel.style.lineHeight;
            const originalWatermarkAlign = watermarkLabel.style.alignItems;
        }

        // --- Editing Logic ---

        function updateEdit() {
            if (!currentImage) return;

            const radius = els.radius.value;
            const scale = els.scale.value;
            const tilt = els.tilt.value;
            const rotate = els.rotate.value;
            const shadow = els.shadow.value;
            const color = els.shadowColor.value;

            // Update Text Values
            els.valRadius.innerText = radius;
            els.valScale.innerText = scale + '%';
            els.valTilt.innerText = tilt + '°';
            els.valRotate.innerText = rotate + '°';
            els.valShadow.innerText = shadow;
            els.shadowHex.innerText = color;

            // Apply styles to Image Wrapper
            // Scale controls width relative to container
            els.imageWrapper.style.width = `${scale}%`;

            // Transform: We apply perspective to the wrapper's parent or the element itself. 
            // For tilt (X/Y rotation) to work well, we used preserve-3d in CSS.
            // A simple tilt usually implies rotating around Y axis or X axis. Let's do a subtle combination or just Y.
            // Based on screenshot, "Tilt" usually means Perspective Rotate Y or X. Let's do Rotate Y + X slight.
            // Actually, let's map Tilt to RotateY and Rotate to RotateZ.
            els.imageWrapper.style.transform = `perspective(1000px) rotateY(${tilt}deg) rotateZ(${rotate}deg)`;

            // Shadow & Border Radius apply to the IMG element (or frame container)
            // Shadow logic: spread affects blur and spread radius
            const shadowOpacity = 0.5;
            // Convert hex to rgba for opacity? Or just use hex. 
            // Large spread makes it look like a dispersed shadow
            const shadowBlur = shadow * 2;
            const shadowSpreadVal = shadow * 0.2;
            // Dynamic offset based on tilt could be cool, but static is safer for now.
            const shadowX = tilt * -0.5;
            const shadowY = 20; // Light comes from top

            // We apply shadow to the frame container or img
            els.frameContainer.style.boxShadow = `${shadowX}px ${shadowY}px ${shadowBlur}px ${shadowSpreadVal}px ${color}`;

            // Radius
            els.previewImg.style.borderRadius = `${radius}px`;
            // Also radius the frame if it has background
            if (els.frameContainer.classList.contains('frame-light') ||
                els.frameContainer.classList.contains('frame-dark') ||
                els.frameContainer.classList.contains('frame-glass')) {
                els.frameContainer.style.borderRadius = `${parseInt(radius) + 8}px`; // slightly larger for frame
            } else {
                els.frameContainer.style.borderRadius = `${radius}px`;
            }
        }

        function setFrame(type) {
            // Reset classes
            els.frameContainer.className = 'transition-all duration-200';
            els.frameContainer.classList.add(`frame-${type}`);

            // Update UI state
            document.querySelectorAll('.frame-btn').forEach(btn => {
                if (btn.dataset.frame === type) btn.classList.add('ring-2', 'ring-purple-500', 'ring-offset-1');
                else btn.classList.remove('ring-2', 'ring-purple-500', 'ring-offset-1');
            });

            updateEdit(); // Re-apply radius logic
        }

        function setBg(value) {
            els.captureArea.className = "relative flex items-center justify-center w-full max-w-5xl aspect-video shadow-sm rounded-lg overflow-hidden transition-all duration-300"; // Reset
            els.captureArea.style.background = value;
        }

        function setBgColor(color) {
            els.captureArea.className = "relative flex items-center justify-center w-full max-w-5xl aspect-video shadow-sm rounded-lg overflow-hidden transition-all duration-300"; // Reset
            els.captureArea.style.background = color;
            document.getElementById('bg-color-picker').value = color; // Sync picker
        }

        function setBgTransparent() {
            els.captureArea.style.background = 'none';
            els.captureArea.className = "relative flex items-center justify-center w-full max-w-5xl aspect-video shadow-sm rounded-lg overflow-hidden transition-all duration-300 checkerboard";
        }

        function setRandomBg() {
            const randomColor = () => '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
            const angle = Math.floor(Math.random() * 360);
            const color1 = randomColor();
            const color2 = randomColor();
            const bg = `linear-gradient(${angle}deg, ${color1}, ${color2})`;
            setBg(bg);
        }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    els.captureArea.style.background = `url(${e.target.result}) center/cover no-repeat`;
                    els.captureArea.classList.remove('checkerboard');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateWatermark() {
            const text = document.getElementById('watermark-text').value;
            const pos = document.getElementById('watermark-pos').value;
            const container = document.getElementById('watermark-container');
            const label = document.getElementById('watermark-label');

            if (!text.trim()) {
                label.classList.remove('opacity-100');
                label.classList.add('opacity-0');
                return;
            }

            label.innerText = text;
            label.classList.remove('opacity-0');
            label.classList.add('opacity-100');

            // Reset positioning classes (keep base classes)
            container.className = 'absolute inset-0 pointer-events-none z-10 p-8 flex flex-col transition-all duration-200';

            switch (pos) {
                case 'tl': container.classList.add('justify-start', 'items-start'); break;
                case 'tr': container.classList.add('justify-start', 'items-end'); break;
                case 'bl': container.classList.add('justify-end', 'items-start'); break;
                case 'br': container.classList.add('justify-end', 'items-end'); break;
            }
        }



        // --- Export ---

        async function exportImage() {
            if (!currentImage) return;

            const btn = document.getElementById('export-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="spinner"></div> Exporting...`;
            btn.disabled = true;

            // Default to 3x quality
            const quality = parseInt(document.getElementById('export-quality').value) || 3;
            const format = document.getElementById('export-format').value; // png or jpeg
            const filename = document.getElementById('export-name').value || 'screenshot';

            const captureNode = els.captureArea;
            const dropZone = els.dropZone;
            const watermarkLabel = document.getElementById('watermark-label');

            // 1. Store original states
            const originalCaptureOverflow = captureNode.style.overflow;
            const originalCapturePadding = captureNode.style.padding;
            const originalCaptureMargin = captureNode.style.margin;

            const originalDropZoneDisplay = dropZone.style.display;

            const originalWatermarkDisplay = watermarkLabel.style.display;
            const originalWatermarkLineHeight = watermarkLabel.style.lineHeight;
            const originalWatermarkAlign = watermarkLabel.style.alignItems;
            const originalWatermarkJustify = watermarkLabel.style.justifyContent;
            const originalWatermarkOpacity = watermarkLabel.style.opacity;

            // 2. Apply temporary fixes for export (Live DOM)

            // Fix: Dotted Box
            dropZone.style.display = 'none';

            // Fix: Missing Shadows
            // We still modify the live DOM to be safe, but html-to-image is better at this.
            captureNode.style.overflow = 'visible';
            captureNode.style.padding = '100px'; // Generous padding for large shadows

            // Fix: Watermark Alignment
            watermarkLabel.style.display = 'flex';
            watermarkLabel.style.lineHeight = 'normal';
            watermarkLabel.style.alignItems = 'center';
            watermarkLabel.style.justifyContent = 'center';
            watermarkLabel.style.opacity = '1';
            watermarkLabel.style.whiteSpace = 'nowrap';

            try {
                // Small timeout to ensure styles render
                await new Promise(resolve => setTimeout(resolve, 50));

                let dataUrl;
                const options = {
                    quality: 0.95, // For JPEG
                    pixelRatio: quality,
                    backgroundColor: null, // Transparent for PNG
                    style: {
                        overflow: 'visible',
                        // Ensure no transform on the capture node itself interferes
                        transform: 'none'
                    }
                };

                if (format === 'jpeg') {
                    options.backgroundColor = '#ffffff'; // JPEGs need a background
                    dataUrl = await htmlToImage.toJpeg(captureNode, options);
                } else {
                    dataUrl = await htmlToImage.toPng(captureNode, options);
                }

                const link = document.createElement('a');
                link.download = `${filename}.${format}`;
                link.href = dataUrl;
                link.click();

            } catch (err) {
                console.error("Export failed", err);
                alert("Failed to export image. Please try again.");
            } finally {
                // 3. Restore original states
                captureNode.style.overflow = originalCaptureOverflow;
                captureNode.style.padding = originalCapturePadding;
                captureNode.style.margin = originalCaptureMargin;

                dropZone.style.display = originalDropZoneDisplay;

                watermarkLabel.style.display = originalWatermarkDisplay;
                watermarkLabel.style.lineHeight = originalWatermarkLineHeight;
                watermarkLabel.style.alignItems = originalWatermarkAlign;
                watermarkLabel.style.justifyContent = originalWatermarkJustify;
                watermarkLabel.style.opacity = originalWatermarkOpacity;
                watermarkLabel.style.whiteSpace = 'normal'; // Reset to normal (or whatever it was, usually normal for this element)

                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Start
        init();

    </script>
</body>

</html>
